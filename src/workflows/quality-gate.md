<purpose>
Run SonarQube quality scan, check gates, and update CONCERNS.md with findings.

Provides objective code quality metrics to inform planning decisions.
</purpose>

<when_to_use>
- Before planning new phases (baseline quality)
- After completing significant work
- When CONCERNS.md needs updating
- Manual quality check anytime
</when_to_use>

<philosophy>
**Quality as input, not gate:**
Quality metrics inform decisions but don't block work. A failing gate means "address this" not "stop everything."

**Automated CONCERNS.md:**
Manual concern tracking is tedious. Let tools find issues, humans prioritize them.

**Optional integration:**
SonarQube is not required. Workflow gracefully handles disabled state.
</philosophy>

<references>
@src/references/sonarqube-integration.md
@src/templates/config.md
@src/templates/codebase/concerns.md
</references>

<process>

<step name="check_config" priority="first">
1. Check if .paul/config.md exists:
   ```bash
   ls .paul/config.md 2>/dev/null
   ```

2. If exists, read and check sonarqube.enabled

3. **If SonarQube disabled or config missing:**
   ```
   SonarQube integration not enabled.

   To enable:
   1. Add to .paul/config.md:
      sonarqube:
        enabled: true
        project_key: [your-project]

   2. Create sonar-project.properties in project root

   3. Run this workflow again
   ```
   Exit workflow.

4. **If enabled:** Extract project_key, continue to verify_prerequisites.
</step>

<step name="verify_prerequisites">
1. Check sonar-project.properties exists:
   ```bash
   ls sonar-project.properties 2>/dev/null
   ```

2. **If missing:**
   ```
   Missing sonar-project.properties

   Create with:
   sonar.projectKey=[project_key from config]
   sonar.projectName=[project name]
   sonar.sources=src

   Or use MCP to create project:
   mcp__sonarqube__sonar_create_project
   ```
   Exit workflow.

3. **If exists:** Continue to run_scan.
</step>

<step name="run_scan">
Run SonarQube scan using MCP:

```
mcp__sonarqube__sonar_scan
  project_path: [current directory absolute path]
```

**Handle results:**
- Success: Continue to check_gates
- Failure: Report error, suggest troubleshooting

Display while scanning:
```
Running SonarQube scan...
Project: [project_key]
```
</step>

<step name="check_gates">
Get quality gate status:

```
mcp__sonarqube__sonar_get_metrics
  project: [project_key]
```

**Parse response for:**
- Quality gate status (OK/ERROR)
- Bug count
- Vulnerability count
- Code smell count
- Coverage percentage
- Duplication percentage

Store metrics for report.

Continue to get_issues.
</step>

<step name="get_issues">
Fetch unresolved issues by severity:

```
mcp__sonarqube__sonar_get_issues
  project: [project_key]
  severity: "CRITICAL"
```

```
mcp__sonarqube__sonar_get_issues
  project: [project_key]
  severity: "MAJOR"
```

**For each issue, extract:**
- File path
- Line number (if available)
- Message
- Severity
- Type (BUG, VULNERABILITY, CODE_SMELL)

Group issues by severity for report.

Continue to update_concerns.
</step>

<step name="update_concerns">
Update .paul/codebase/CONCERNS.md with scan results.

**If CONCERNS.md doesn't exist:**
Create from template first.

**Add or update SonarQube section:**

```markdown
## SonarQube Analysis

**Last Scan:** [YYYY-MM-DD HH:MM]
**Quality Gate:** [PASSED/FAILED]

### Metrics

| Metric | Value |
|--------|-------|
| Bugs | [N] |
| Vulnerabilities | [N] |
| Code Smells | [N] |
| Coverage | [N]% |
| Duplications | [N]% |

### Critical Issues

[List CRITICAL issues with file paths]

**[Issue type]:** [message]
- File: `[path]`

### Major Issues

[List MAJOR issues, limit to top 10]

**[Issue type]:** [message]
- File: `[path]`

---
*Auto-generated by /paul-quality-gate*
*Run scan again to update*
```

**If section already exists:**
Replace with new data (don't append).

Continue to report_results.
</step>

<step name="report_results">
Display summary:

```
════════════════════════════════════════
QUALITY GATE: [PASSED/FAILED]
════════════════════════════════════════

Project: [project_key]
Scanned: [timestamp]

Metrics:
  Bugs:            [N]
  Vulnerabilities: [N]
  Code Smells:     [N]
  Coverage:        [N]%
  Duplications:    [N]%

Issues:
  CRITICAL: [N]
  MAJOR:    [N]
  MINOR:    [N]

Updated: .paul/codebase/CONCERNS.md

────────────────────────────────────────
[If FAILED:]
▶ NEXT: Address critical issues before continuing

[If PASSED:]
▶ Quality gate passed. Continue with planning.
────────────────────────────────────────
```

End workflow.
</step>

</process>

<output>
- Updated .paul/codebase/CONCERNS.md with SonarQube section
- Quality gate status displayed
- Actionable next steps based on results
</output>

<error_handling>
**SonarQube server unreachable:**
- Report connection error
- Suggest checking server status
- Provide manual scan instructions

**Scan timeout:**
- Report timeout
- Suggest running scan directly
- Note: large projects may need increased timeout

**MCP tools unavailable:**
- Report MCP error
- Suggest checking MCP server configuration
- Provide manual alternative

**No issues found:**
- Report clean scan
- Note in CONCERNS.md: "No significant concerns detected"
</error_handling>
